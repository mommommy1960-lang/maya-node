# SPDX-License-Identifier: CERL-1.0
# Copyright (c) 2025 MAYA Node Contributors
#
# Constrained Ethics Runtime License 1.0
# This code is licensed under CERL-1.0. See LICENSE-CERL-1.0 for full terms.

name: Security & Ethics Checks

on:
  push:
    branches: [ main, develop, copilot/** ]
  pull_request:
    branches: [ main, develop ]

jobs:
  security-scan:
    name: Security Scanning
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install bandit safety pylint
    
    - name: Run Bandit security scan
      run: |
        bandit -r src/ -f json -o bandit-report.json || true
        bandit -r src/ -f txt
      continue-on-error: true
    
    - name: Check dependencies for vulnerabilities
      run: |
        pip freeze > requirements.txt
        safety check --file requirements.txt || true
      continue-on-error: true
    
    - name: Upload security reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: security-reports
        path: |
          bandit-report.json

  ethics-verification:
    name: Ethics Constraint Verification
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Verify CERL headers
      run: |
        echo "Checking for CERL-1.0 license headers..."
        missing=0
        for file in $(find src/ -name "*.py" -o -name "*.js" -o -name "*.ts"); do
          if ! grep -q "CERL-1.0" "$file"; then
            echo "Missing CERL header: $file"
            missing=$((missing + 1))
          fi
        done
        if [ $missing -gt 0 ]; then
          echo "ERROR: $missing files missing CERL-1.0 headers"
          exit 1
        fi
        echo "All files have CERL-1.0 headers âœ“"
    
    - name: Check for prohibited patterns
      run: |
        echo "Scanning for prohibited use patterns..."
        # Check for weaponization references
        if grep -r "weapon\|military\|missile" src/ --include="*.py" --include="*.js"; then
          echo "WARNING: Found potential weaponization references"
        fi
        echo "Pattern scan complete"
    
    - name: Run ethics engine tests
      run: |
        python -m pytest tests/ethics/ -v || echo "Ethics tests not yet fully configured"

  code-quality:
    name: Code Quality
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install linting tools
      run: |
        pip install pylint flake8 black
    
    - name: Run pylint
      run: |
        pylint src/ --exit-zero --output-format=text --reports=yes
      continue-on-error: true
    
    - name: Check code formatting
      run: |
        black --check src/ || echo "Code formatting check complete"
      continue-on-error: true

  test-suite:
    name: Test Suite
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
    
    - name: Install test dependencies
      run: |
        pip install pytest pytest-cov
    
    - name: Run runtime tests
      run: |
        python -m pytest tests/runtime/ -v
      continue-on-error: true
    
    - name: Run ethics tests
      run: |
        python -m pytest tests/ethics/ -v
      continue-on-error: true
    
    - name: Run ledger integrity tests
      run: |
        python -m pytest tests/ledger/ -v
      continue-on-error: true
    
    - name: Generate coverage report
      run: |
        python -m pytest tests/ --cov=src --cov-report=term --cov-report=html
      continue-on-error: true
    
    - name: Upload coverage report
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: htmlcov/
